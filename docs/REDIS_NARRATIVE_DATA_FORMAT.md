# StoryArt: Redis Narrative Data Format Guide

**Version**: 1.0  
**Date**: 2025-12-31  
**Owner**: StoryArt Development Team  
**Audience**: StoryTeller Architect & Development Team

## 1. Overview

This document provides the definitive specification for the JSON data structure required in Redis for proper ingestion by the StoryArt application. To ensure seamless and accurate image generation, the narrative data for each episode, generated by the StoryTeller system, must conform to this structure before being transferred to Redis.

StoryArt's `databaseContextService` is designed to read this precise format. Adherence to this guide is critical for the entire script-to-image pipeline to function correctly.

---

## 2. Redis Key Convention

All episode data must be stored in Redis using the following key format:

`session:storyart:episode:{episode_number}`

-   `{episode_number}`: The integer representing the episode number (e.g., `1`, `2`, `3`).

**Example:** The key for Episode 1 would be `session:storyart:episode:1`.

---

## 3. Core JSON Data Structure (`EnhancedEpisodeContext`)

The value stored at the Redis key must be a single JSON string representing the `EnhancedEpisodeContext` object. This object encapsulates all the narrative, character, and environmental details required for an entire episode.

The following TypeScript interfaces define the required structure. A complete, practical example is provided in Section 4.

### 3.1. Top-Level Structure

```typescript
interface EnhancedEpisodeContext {
  episode: {
    episode_number: number;
    episode_title: string;
    episode_summary: string;
    story_context: string;
    narrative_tone: string;
    core_themes: string;
    characters: CharacterContext[];
    scenes: SceneContext[]; // MUST contain exactly 4 scenes per episode.
  }
}
```

### 3.2. Character Structure

This defines a character's base appearance and, critically, their location-specific looks.

```typescript
interface CharacterContext {
  character_name: string;
  aliases: string[];
  base_trigger: string;               // LORA trigger, e.g., "cat_mitchell_v2".
  visual_description: string;       // General, non-location-specific description.
  location_contexts: CharacterLocationContext[]; // Defines location-specific appearances.
}

// **CRITICAL FOR VISUAL CONSISTENCY**
// This object dictates how a character's appearance changes based on their environment.
interface CharacterLocationContext {
  location_name: string;            // Must match a `location.name` in a SceneContext.
  physical_description: string;     // Character's physical state in this location.
  clothing_description: string;     // Specific clothing worn here.
  demeanor_description: string;     // Mood or behavior.
  swarmui_prompt_override: string; // **最重要 (Most Important)**: A complete, pre-written SwarmUI prompt fragment that defines the character's full appearance for this location. This is a primary driver of the final image prompt.
  temporal_context: string;         // e.g., "POST_COLLAPSE".
  lora_weight_adjustment: number;   // Fine-tuning value for the LORA weight.
}
```

### 3.3. Scene and Location Structure

This defines each of the four scenes, linking them to detailed locations and the characters within them.

```typescript
interface SceneContext {
  scene_number: number;
  scene_title: string;
  scene_summary: string;
  roadmap_location: string;         // The location name from the roadmap, used for lookups.
  location: LocationContext;       // The detailed location object for this scene.
  character_appearances: CharacterAppearance[]; // Specifies which characters are in this scene.
}

// Defines the visual and atmospheric details of a location.
interface LocationContext {
  id: string;                       // UUID for the location.
  name: string;
  description: string;              // Narrative description.
  visual_description: string;       // **Primary driver of the background visuals.**
  atmosphere: string;               // Mood, e.g., "Oppressive, chaotic".
  atmosphere_category: string;     // e.g., "Tense".
  geographical_location: string;    // e.g., "Atlanta, GA".
  time_period: string;              // e.g., "Near Future".
  cultural_context: string;
  key_features: string;             // A JSON array of key features stringified, e.g., "[\"shattered windows\", \"flickering lights\"]".
  visual_reference_url: string;
  significance_level: string;
  artifacts: ArtifactContext[];     // **CRITICAL FOR BACKGROUND DETAIL**
  tactical_override_location: string | null; // If this location should use another's character appearance rules (e.g., a dangerous place requiring tactical gear).
}

// **CRITICAL FOR BACKGROUND DETAIL**
// Artifacts are specific objects or environmental details that get injected into the prompt.
interface ArtifactContext {
  artifact_name: string;
  artifact_type: string;            // e.g., "KEY_ITEM", "FORESHADOWING".
  description: string;
  swarmui_prompt_fragment: string;  // **最重要 (Most Important)**: This text is directly appended to the SwarmUI prompt to ensure specific details appear in the image.
  always_present: boolean;
  scene_specific: boolean;
}

// Links a character to their specific appearance for a scene.
interface CharacterAppearance {
  character_name: string;
  location_context: CharacterLocationContext; // The specific appearance rules for this scene.
  tactical_override_applied: boolean;
}
```

---

## 4. Complete 4-Scene Episode Example

This example demonstrates the full structure for a single episode. This JSON should be stringified and set as the value for the Redis key `session:storyart:episode:1`.

```json
{
  "episode": {
    "episode_number": 1,
    "episode_title": "The Atlanta Extraction",
    "episode_summary": "Cat and Daniel infiltrate the ruined NHIA Facility 7 to retrieve critical data, facing unforeseen dangers within its decaying walls.",
    "story_context": "Set in a post-collapse near-future, advanced technology coexists with urban decay. A deadly virus has reshaped society, and factions vie for control of remaining resources and data.",
    "narrative_tone": "Tense, Action-Oriented, Grim, Mysterious",
    "core_themes": "Survival, Corporate Espionage, Betrayal, Humanity's Resilience",
    "characters": [
      {
        "character_name": "Cat Mitchell",
        "aliases": ["Catherine Mitchell"],
        "base_trigger": "cat_mitchell_v2",
        "visual_description": "A former field investigator in her early 30s, with a lean, athletic build. She has dark brown hair, often tied back, and observant green eyes. A medical caduceus tattoo is visible on her forearm.",
        "location_contexts": [
          {
            "location_name": "NHIA Facility 7 - Corridors",
            "physical_description": "Alert and focused, with minor smudges of dirt on her face from infiltration.",
            "clothing_description": "Wears a dark, form-fitting tactical suit with a utility belt and combat boots. Her hair is in a tight tactical bun.",
            "demeanor_description": "Moves with quiet confidence and precision, constantly scanning her surroundings.",
            "swarmui_prompt_override": "Catherine 'Cat' Mitchell as field investigator, 32, dark brown tactical bun, green eyes alert and focused, wearing tactical field gear, tactical vest, combat boots, burn marks on forearms, investigating with focused determination.",
            "temporal_context": "POST_COLLAPSE",
            "lora_weight_adjustment": 1.0
          },
          {
            "location_name": "Dan's Safehouse",
            "physical_description": "Relaxed but still watchful. The tension from the field has eased slightly.",
            "clothing_description": "Comfortable jeans and a dark t-shirt, her usual tactical gear stored away.",
            "demeanor_description": "A rare moment of quiet contemplation, though her guard is never completely down.",
            "swarmui_prompt_override": "Catherine 'Cat' Mitchell in safehouse, 32, dark brown hair completely down and loose, green eyes showing vulnerability and peace, wearing jeans and t-shirt, relaxed posture, safehouse interior background, soft lighting.",
            "temporal_context": "POST_COLLAPSE",
            "lora_weight_adjustment": 1.0
          }
        ]
      },
      {
        "character_name": "Daniel O'Brien",
        "aliases": ["Dan"],
        "base_trigger": "daniel_obrien_v1",
        "visual_description": "A former special forces soldier, 35, with a powerful build, stark white hair, and intense green eyes. He is a formidable presence.",
        "location_contexts": [
          {
            "location_name": "NHIA Facility 7 - Corridors",
            "physical_description": "In his element, moving with the economy of a seasoned soldier.",
            "clothing_description": "Full tactical gear, including a plate carrier, helmet, and assorted weapons systems.",
            "demeanor_description": "Hyper-vigilant and protective, acting as the shield for the operation.",
            "swarmui_prompt_override": "Daniel O'Brien in full tactical mode, 35, 6'2\", stark white hair, green eyes scanning threats, wearing complete tactical gear, plate carrier, weapons systems, protective stance in chaotic emergency zone, urban decay background.",
            "temporal_context": "POST_COLLAPSE",
            "lora_weight_adjustment": 1.0
          }
        ]
      }
    ],
    "scenes": [
      {
        "scene_number": 1,
        "scene_title": "Breach",
        "scene_summary": "Cat and Daniel make a forced entry into the derelict NHIA Facility 7, navigating the ruined reception area.",
        "roadmap_location": "NHIA Facility 7",
        "location": {
          "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
          "name": "NHIA Facility 7 - Reception Area",
          "description": "The former main entrance to the facility, now a scene of destruction.",
          "visual_description": "Destroyed reception area with scattered debris, a broken security checkpoint, and abandoned visitor logs. Emergency lighting casts long, eerie shadows across shattered glass partitions.",
          "atmosphere": "Tense, Silent, Foreboding",
          "atmosphere_category": "Stealth",
          "geographical_location": "Atlanta, GA",
          "time_period": "2042",
          "cultural_context": "Post-Collapse Corporate Ruin",
          "key_features": "[\"broken security desk\", \"shattered glass\", \"emergency lights\"]",
          "visual_reference_url": "",
          "significance_level": "High",
          "artifacts": [
            {
              "artifact_name": "Concrete Rubble",
              "artifact_type": "Environmental",
              "description": "Piles of broken concrete and dust from a collapsed ceiling.",
              "swarmui_prompt_fragment": "piles of concrete rubble and dust, exposed rebar",
              "always_present": true,
              "scene_specific": false
            }
          ],
          "tactical_override_location": "Atlanta Emergency Zone"
        },
        "character_appearances": []
      },
      {
        "scene_number": 2,
        "scene_title": "The Corridors",
        "scene_summary": "The team moves deeper into the facility, navigating the dark and dangerous corridors leading to the lower levels.",
        "roadmap_location": "NHIA Facility 7",
        "location": {
          "id": "b2c3d4e5-f6a1-b2c3-d4e5-f6a1b2c3d4e5",
          "name": "NHIA Facility 7 - Corridors",
          "description": "The sterile, decaying hallways of the research facility.",
          "visual_description": "Long, sterile corridors with flickering emergency lights casting dancing shadows on the walls. Abandoned computer terminals and scattered medical equipment line the path.",
          "atmosphere": "Suspenseful, Dangerous",
          "atmosphere_category": "Exploration",
          "geographical_location": "Atlanta, GA",
          "time_period": "2042",
          "cultural_context": "Post-Collapse Corporate Ruin",
          "key_features": "[\"flickering lights\", \"abandoned terminals\", \"medical equipment\"]",
          "visual_reference_url": "",
          "significance_level": "Medium",
          "artifacts": [
            {
              "artifact_name": "Shattered Containment Pods",
              "artifact_type": "Environmental",
              "description": "Broken, empty patient containment pods line the hallway, their glass shattered.",
              "swarmui_prompt_fragment": "rows of shattered glass containment pods, ominous green fluid leaked onto the floor",
              "always_present": true,
              "scene_specific": true
            }
          ],
          "tactical_override_location": "Atlanta Emergency Zone"
        },
        "character_appearances": [
          {
            "character_name": "Cat Mitchell",
            "location_context": {
              "location_name": "NHIA Facility 7 - Corridors",
              "physical_description": "Alert and focused, with minor smudges of dirt on her face from infiltration.",
              "clothing_description": "Wears a dark, form-fitting tactical suit with a utility belt and combat boots. Her hair is in a tight tactical bun.",
              "demeanor_description": "Moves with quiet confidence and precision, constantly scanning her surroundings.",
              "swarmui_prompt_override": "Catherine 'Cat' Mitchell as field investigator, 32, dark brown tactical bun, green eyes alert and focused, wearing tactical field gear, tactical vest, combat boots, burn marks on forearms, investigating with focused determination.",
              "temporal_context": "POST_COLLAPSE",
              "lora_weight_adjustment": 1.0
            },
            "tactical_override_applied": true
          },
          {
            "character_name": "Daniel O'Brien",
            "location_context": {
              "location_name": "NHIA Facility 7 - Corridors",
              "physical_description": "In his element, moving with the economy of a seasoned soldier.",
              "clothing_description": "Full tactical gear, including a plate carrier, helmet, and assorted weapons systems.",
              "demeanor_description": "Hyper-vigilant and protective, acting as the shield for the operation.",
              "swarmui_prompt_override": "Daniel O'Brien in full tactical mode, 35, 6'2\", stark white hair, green eyes scanning threats, wearing complete tactical gear, plate carrier, weapons systems, protective stance in chaotic emergency zone, urban decay background.",
              "temporal_context": "POST_COLLAPSE",
              "lora_weight_adjustment": 1.0
            },
            "tactical_override_applied": true
          }
        ]
      },
      {
        "scene_number": 3,
        "scene_title": "The Vault",
        "scene_summary": "They locate the primary target: a reinforced data vault on a lower level, and prepare to bypass its security.",
        "roadmap_location": "NHIA Facility 7 - Data Vault",
        "location": {
            "id": "c3d4e5f6-a1b2-c3d4-e5f6-a1b2c3d4e5f6",
            "name": "NHIA Facility 7 - Data Vault",
            "description": "An underground data vault, the heart of the facility.",
            "visual_description": "A massive, reinforced vault door set into a concrete wall, covered in biohazard warnings. The air is cold and still. A sophisticated electronic lock glows dimly on the door.",
            "atmosphere": "High Stakes, Tense",
            "atmosphere_category": "Objective",
            "geographical_location": "Atlanta, GA",
            "time_period": "2042",
            "cultural_context": "Post-Collapse Corporate Ruin",
            "key_features": "[\"reinforced vault door\", \"biohazard warnings\", \"electronic lock\"]",
            "visual_reference_url": "",
            "significance_level": "Critical",
            "artifacts": [
                {
                    "artifact_name": "Emergency Biohazard Warnings",
                    "artifact_type": "Environmental",
                    "description": "Faded but still visible biohazard warnings plastered on the walls and the vault door.",
                    "swarmui_prompt_fragment": "faded yellow and black biohazard warning symbols",
                    "always_present": true,
                    "scene_specific": false
                }
            ],
            "tactical_override_location": "Atlanta Emergency Zone"
        },
        "character_appearances": []
      },
      {
        "scene_number": 4,
        "scene_title": "Extraction",
        "scene_summary": "After securing the data, the team extracts, only to find their exit route compromised.",
        "roadmap_location": "Dan's Safehouse",
        "location": {
            "id": "d4e5f6a1-b2c3-d4e5-f6a1-b2c3d4e5f6a1",
            "name": "Dan's Safehouse",
            "description": "A secure, hidden location for the team to regroup.",
            "visual_description": "A sparsely furnished but secure room with tactical gear neatly stored on one wall and a bank of computer monitors on a desk. The lighting is low and functional.",
            "atmosphere": "Temporary Relief, Underlying Tension",
            "atmosphere_category": "Safehouse",
            "geographical_location": "Atlanta, GA",
            "time_period": "2042",
            "cultural_context": "Post-Collapse Urban Hideout",
            "key_features": "[\"tactical gear wall\", \"computer monitors\", \"sparse furniture\"]",
            "visual_reference_url": "",
            "significance_level": "High",
            "artifacts": [],
            "tactical_override_location": null
        },
        "character_appearances": [
            {
              "character_name": "Cat Mitchell",
              "location_context": {
                "location_name": "Dan's Safehouse",
                "physical_description": "Relaxed but still watchful. The tension from the field has eased slightly.",
                "clothing_description": "Comfortable jeans and a dark t-shirt, her usual tactical gear stored away.",
                "demeanor_description": "A rare moment of quiet contemplation, though her guard is never completely down.",
                "swarmui_prompt_override": "Catherine 'Cat' Mitchell in safehouse, 32, dark brown hair completely down and loose, green eyes showing vulnerability and peace, wearing jeans and t-shirt, relaxed posture, safehouse interior background, soft lighting.",
                "temporal_context": "POST_COLLAPSE",
                "lora_weight_adjustment": 1.0
              },
              "tactical_override_applied": false
            }
        ]
      }
    ]
  }
}
