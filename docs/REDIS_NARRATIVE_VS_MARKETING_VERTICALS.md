# Redis Storage: Narrative-based vs Marketing-based Vertical Prompts

## Overview

This document explains how the StoryArt system now stores and differentiates between two types of vertical (9:16) prompts in Redis:

1. **Narrative-based Verticals**: Generated from individual beat analysis for long-form storytelling
2. **Marketing-based Verticals**: Generated from full episode analysis for promotional content

## Data Structure Changes

### Updated BeatPrompts Interface

```typescript
export interface BeatPrompts {
  beatId: string;
  cinematic: SwarmUIPrompt;                                    // 16:9 cinematic format
  vertical: SwarmUIPrompt;                                     // 9:16 narrative-based vertical (beat analysis)
  marketingVertical?: SwarmUIPrompt;                          // 9:16 marketing-focused vertical (episode-wide analysis)
}
```

### Stored in Redis Session

The Redis session now stores three types of prompts per beat:

```
storyart:session:{timestamp}
├── scriptText
├── episodeContext
├── analyzedEpisode
│   └── scenes[]
│       └── beats[]
│           └── prompts
│               ├── cinematic    → 16:9 prompt (beat-based)
│               ├── vertical     → 9:16 prompt (beat-based, narrative-focused)
│               └── marketingVertical → 9:16 prompt (episode-based, marketing-focused)
```

## Generation Approaches

### 1. Narrative-based Verticals (Existing System)

**Source**: Individual beat analysis
**Purpose**: Images for the actual episode narrative
**Generation**: 
- Analyzes each beat's `core_action`, `visual_anchor`, `emotional_tone`
- Creates vertical prompts optimized for character focus and story continuation
- Uses beat-specific context and location attributes
- Generated during standard beat analysis pipeline

**Example**: "Cat advancing through the ruined facility" → Vertical image showing this specific narrative moment

### 2. Marketing-based Verticals (New System)

**Source**: Full episode analysis for marketing
**Purpose**: Promotional images to drive viewership to the full episode
**Generation**:
- Analyzes entire episode narrative to identify most compelling moments
- Creates vertical prompts optimized for social media engagement
- Uses episode-wide context with emphasis on hooks and emotional impact
- Generated by `videoShortMarketingService.ts` or when enhancing sessions

**Example**: "Most dramatic moment in the episode" → Vertical image designed to make viewers stop scrolling and watch the full episode

## Implementation in Services

### Prompt Generation Service

Both `promptGenerationService.ts` and `qwenPromptService.ts` now support:
- Generating all three prompt types (cinematic, narrative vertical, marketing vertical)
- Proper post-processing to ensure correct dimensions and FLUX parameters
- Schema validation for all prompt types

### Redis Integration

`redisVideoShortIntegrationService.ts` provides:
- Functions to generate marketing campaigns from Redis sessions
- Enhancement of existing sessions with marketing verticals
- Retrieval of marketing-focused prompts
- Summary reporting on marketing potential

## Key Differentiators

| Aspect | Narrative-based Verticals | Marketing-based Verticals |
|--------|---------------------------|----------------------------|
| **Source** | Individual beat analysis | Full episode analysis |
| **Purpose** | Scene representation | Promotion/viewership drive |
| **Focus** | Story continuity | Attention/hook generation |
| **Context** | Beat-specific | Episode-wide themes |
| **Composition** | Character-environment balance | Mobile-optimized attention grabbers |
| **Language** | Narrative-focused | Marketing-hook focused |
| **Storage** | `beat.prompts.vertical` | `beat.prompts.marketingVertical` |

## Marketing Vertical Characteristics

Marketing verticals are specifically designed with:

1. **Social Media Optimization**:
   - Hooks that stop scrolling in feeds
   - Attention-grabbing visual elements
   - Mobile-first composition

2. **Buzz Generation**:
   - Focus on most compelling episode moments
   - Emotional hooks to generate curiosity
   - Story connections that tease the full narrative

3. **Engagement Focus**:
   - Language optimized for social media
   - Emotional intensity for engagement
   - Visual elements that drive clicks

## Redis Session Access Patterns

### Reading Narrative-based Verticals
```typescript
// Access standard narrative verticals
const narrativeVertical = session.analyzedEpisode.scenes[sceneIdx].beats[beatIdx].prompts.vertical;
```

### Reading Marketing-based Verticals
```typescript
// Access marketing verticals (if available)
const marketingVertical = session.analyzedEpisode.scenes[sceneIdx].beats[beatIdx].prompts?.marketingVertical;
```

### Checking Marketing Potential
```typescript
// Use the integration service to check marketing potential
import { getVideoShortSummaryFromSession } from './redisVideoShortIntegrationService';

const summary = await getVideoShortSummaryFromSession();
console.log(`Has marketing prompts: ${summary.hasMarketingPrompts}`);
console.log(`Marketing prompts count: ${summary.marketingPromptCount}`);
```

## Backward Compatibility

- Existing narrative-based verticals continue to work as before
- Marketing verticals are optional (using `?` in the type definition)
- Systems without marketing verticals continue to function normally
- Both types of verticals can coexist in the same session

## Use Cases

### Narrative-based Verticals
- Long-form episode production
- Scene-by-scene image generation
- Story continuity in visual elements
- Traditional beat-to-image pipelines

### Marketing-based Verticals
- Social media promotions
- Trailer/preview material
- Audience acquisition campaigns
- Episode teaser content for TikTok/Instagram/YouTube Shorts
- Marketing campaign asset generation

The system now fully supports both approaches with clear separation and easy retrieval of either type from Redis storage.