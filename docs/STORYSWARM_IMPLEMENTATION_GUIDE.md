# StorySwarm Beats-Only Mode - Implementation Guide

**Estimated Time:** 2-3 hours
**Risk:** Low (backward compatible)
**Testing:** Simple (toggle environment variable)

---

## Step 1: Add Environment Variable (5 minutes)

### File: `E:\REPOS\storyart\.env`

Add this line:
```env
# Prompt Generation Mode: "storyart" (current) or "storyswarm" (beats-only)
PROMPT_GENERATION_MODE=storyart
```

### File: `E:\REPOS\storyart\.env.example`

Document the new variable:
```env
# ============================================================================
# PROMPT GENERATION CONFIGURATION
# ============================================================================
# Mode: "storyart" (generate prompts locally) or "storyswarm" (external pipeline)
PROMPT_GENERATION_MODE=storyart

# When set to "storyswarm", StoryArt will:
# - Create beats with full metadata
# - Skip prompt generation
# - Save beats-only to Redis
# - StorySwarm fetches beats and generates rich narrative prompts
```

---

## Step 2: Add Helper Function (10 minutes)

### File: `E:\REPOS\storyart\services\geminiService.ts`

Add after the existing `getGeminiMaxTokens()` function (around line 82):

```typescript
/**
 * Get prompt generation mode from environment
 * @returns "storyart" (generate prompts) or "storyswarm" (skip prompts)
 */
export const getPromptGenerationMode = (): 'storyart' | 'storyswarm' => {
  // Check environment variable
  const mode = (() => {
    if (typeof import.meta !== 'undefined' && import.meta.env) {
      return import.meta.env.VITE_PROMPT_GENERATION_MODE ||
             import.meta.env.PROMPT_GENERATION_MODE;
    }
    return (process.env as any).VITE_PROMPT_GENERATION_MODE ||
           (process.env as any).PROMPT_GENERATION_MODE;
  })();

  // Validate and return
  if (mode === 'storyswarm') {
    console.log('[Gemini Config] Prompt Generation Mode: storyswarm (beats-only)');
    return 'storyswarm';
  }

  console.log('[Gemini Config] Prompt Generation Mode: storyart (full pipeline)');
  return 'storyart';
};
```

---

## Step 3: Add Conditional Logic (30 minutes)

### File: `E:\REPOS\storyart\services\geminiService.ts`

Find the section after beat analysis completes (around line 440).

**BEFORE:**
```typescript
onProgress?.('Processing Gemini response...');
const jsonString = response.text.trim();
return await parseGeminiResponse(jsonString);
```

**AFTER:**
```typescript
onProgress?.('Processing Gemini response...');
const jsonString = response.text.trim();
const analyzedEpisode = await parseGeminiResponse(jsonString);

// Check if we should generate prompts or use beats-only mode
const promptMode = getPromptGenerationMode();

if (promptMode === 'storyswarm') {
  // Beats-only mode: Skip prompt generation
  onProgress?.('Skipping prompt generation (StorySwarm mode)');
  console.log('[Gemini] Beats-only mode enabled - prompts will be generated by StorySwarm');
  console.log('[Gemini] Saved beats to Redis without prompts');
  return analyzedEpisode;
}

// StoryArt mode: Generate prompts (current behavior)
onProgress?.('Generating prompts for beats...');
// ... existing prompt generation code continues ...
```

### Also update the chunked processing section (around line 450)

**Find this section:**
```typescript
// Merge chunks
const finalEpisode = mergeAnalyzedEpisodes(analyzedChunks);
return finalEpisode;
```

**Replace with:**
```typescript
// Merge chunks
const finalEpisode = mergeAnalyzedEpisodes(analyzedChunks);

// Check if we should generate prompts
const promptMode = getPromptGenerationMode();

if (promptMode === 'storyswarm') {
  onProgress?.('Skipping prompt generation (StorySwarm mode)');
  console.log('[Gemini] Beats-only mode enabled - prompts will be generated by StorySwarm');
  return finalEpisode;
}

// StoryArt mode: Continue with prompt generation
onProgress?.('Generating prompts for beats...');
// ... existing prompt generation code ...

return finalEpisode;
```

---

## Step 4: Update UI to Show Mode (20 minutes)

### File: `E:\REPOS\storyart\components\InputPanel.tsx`

Add a mode indicator near the Gemini config display (around line 82):

```typescript
// After the existing Gemini config display
const promptMode = import.meta.env.VITE_PROMPT_GENERATION_MODE ||
                   import.meta.env.PROMPT_GENERATION_MODE ||
                   'storyart';

// Add to the UI
<div className="text-xs text-gray-400 mt-1">
  Prompt Mode: {promptMode === 'storyswarm' ? 'üêù StorySwarm (beats-only)' : 'üé® StoryArt (full pipeline)'}
</div>
```

---

## Step 5: Testing (1 hour)

### Test 1: Verify Backward Compatibility

```bash
# Ensure mode is set to storyart
echo "PROMPT_GENERATION_MODE=storyart" >> .env

# Run analysis
npm run dev

# Expected: Beats + prompts generated (current behavior)
```

### Test 2: Verify Beats-Only Mode

```bash
# Switch to storyswarm mode
# Edit .env: PROMPT_GENERATION_MODE=storyswarm

# Run analysis
npm run dev

# Expected:
# - Console shows: "[Gemini] Beats-only mode enabled"
# - Beats created
# - NO prompts generated
# - Redis session has beats WITHOUT prompt field
```

### Test 3: Verify Redis Schema

```javascript
// In browser console after analysis
const session = JSON.parse(localStorage.getItem('currentSession'));
const beat = session.analyzedEpisode.scenes[0].beats[0];

console.log('Beat has prompt field:', 'prompt' in beat);
// StoryArt mode: true
// StorySwarm mode: false
```

---

## Step 6: Commit Changes (10 minutes)

```bash
git add .env .env.example services/geminiService.ts components/InputPanel.tsx docs/STORYSWARM_*.md
git commit -m "feat: add beats-only mode for StorySwarm integration

FEATURE: Add PROMPT_GENERATION_MODE environment variable

When PROMPT_GENERATION_MODE=storyswarm:
- StoryArt creates beats with full metadata
- Skips prompt generation
- Saves beats-only to Redis
- StorySwarm fetches beats and generates rich narrative prompts

When PROMPT_GENERATION_MODE=storyart (default):
- Full backward compatibility
- Current behavior unchanged
- Beats + prompts generated

Implementation:
- Added getPromptGenerationMode() helper
- Added conditional logic after beat analysis
- Added UI mode indicator
- Updated .env.example with documentation

Benefits:
- StorySwarm's 6-agent pipeline produces richer prompts
- Separation of concerns (beat creation vs prompt generation)
- Zero risk (backward compatible)

Related: docs/STORYSWARM_INTEGRATION_PLAN.md

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Optional: Add StorySwarm API Integration (Future)

When StorySwarm API is ready:

```typescript
// services/storyswarmService.ts
export async function generatePromptsViaStorySwarm(
  sessionTimestamp: number,
  storyId: string
): Promise<GeneratedPrompts> {
  const response = await fetch('http://localhost:8050/api/generate-prompts', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      sessionTimestamp,
      storyId,
      mode: 'visual_prompt_pipeline'
    })
  });

  return await response.json();
}
```

---

## Troubleshooting

### Issue: Mode not detected

**Symptom:** Console shows "storyart" mode but .env says "storyswarm"

**Solution:**
1. Restart dev server (`npm run dev`)
2. Check VITE_ prefix added: `VITE_PROMPT_GENERATION_MODE=storyswarm`
3. Clear browser cache

### Issue: Prompts still generated in storyswarm mode

**Symptom:** Beats have prompt field even in storyswarm mode

**Solution:**
1. Check console for mode detection log
2. Verify conditional logic was added correctly
3. Ensure `getPromptGenerationMode()` is called before prompt generation

---

## Success Criteria

‚úÖ Environment variable added and documented
‚úÖ Helper function works correctly
‚úÖ Conditional logic skips prompts in storyswarm mode
‚úÖ UI shows current mode
‚úÖ Backward compatible (storyart mode works as before)
‚úÖ Redis beats-only schema validated
‚úÖ Console logs show mode selection

---

**Ready to implement? This should take ~2-3 hours total.**
