# YOLO Segmentation Tuning Guide for StoryArt

## Overview
This document provides comprehensive guidance for tuning YOLO segmentation parameters in SwarmUI prompts generated by StoryArt. Based on the latest SwarmUI updates, YOLO thresholds are now properly enforced, making parameter tuning critical for optimal face detection.

## Current Implementation

### Updated YOLO Tags
**Before (Problematic):**
```
<segment:yolo-face_yolov9c.pt-1,0.7,1>
<segment:yolo-face_yolov9c.pt,0.7,0.5>
```

**After (Optimized):**
```
<segment:yolo-face_yolo11m-seg.pt-1,0.35,0.5>
<segment:yolo-face_yolo11m-seg.pt,0.35,0.5>
```

### Key Changes Made
1. **Model**: `yolov9c.pt` → `yolo11m-seg.pt` (latest YOLO11 medium segmentation)
2. **Confidence**: `0.7` → `0.35` (more balanced detection)
3. **IoU**: `1` → `0.5` (prevents SwarmUI warnings and resets)

## Parameter Explanation

### Confidence Threshold (First Number)
Controls the minimum confidence required to accept a face detection.

**Range**: 0.0 - 1.0
**Default**: 0.25 (SwarmUI fallback)
**Our Setting**: 0.35

**Tuning Guidelines:**
- **0.20-0.25**: Catch small, obscured, or angled faces
- **0.30-0.40**: Balanced detection (our current setting)
- **0.45-0.60**: Reduce false positives, may miss some faces
- **0.70+**: Very strict, likely to miss many faces

**When to Adjust:**
- **Lower (0.25-0.30)**: If faces are being missed in crowd scenes
- **Higher (0.40-0.50)**: If getting false face detections on objects

### IoU Threshold (Second Number)
Controls non-maximum suppression overlap between detections.

**Range**: 0.0 - 1.0
**Default**: 0.45 (SwarmUI standard)
**Our Setting**: 0.5

**Tuning Guidelines:**
- **0.3-0.4**: Aggressive suppression, fewer overlapping faces
- **0.5-0.6**: Balanced suppression (our current setting)
- **0.7+**: Keep more overlapping instances

**When to Adjust:**
- **Lower (0.3-0.4)**: If getting duplicate face masks
- **Higher (0.6-0.7)**: If multiple faces are being suppressed when they shouldn't be

### Model Selection
**Current**: `yolo11m-seg.pt` (YOLO11 Medium Segmentation)

**Available Options:**
- `yolo11n-seg.pt`: Nano (fastest, least accurate)
- `yolo11s-seg.pt`: Small (balanced speed/accuracy)
- `yolo11m-seg.pt`: Medium (our choice - good balance)
- `yolo11l-seg.pt`: Large (most accurate, slower)
- `yolo11x-seg.pt`: Extra Large (maximum accuracy, slowest)

**When to Consider Alternatives:**
- **yolo11n-seg.pt**: For faster processing with acceptable accuracy loss
- **yolo11l-seg.pt**: For maximum accuracy in critical scenes

## Scene-Specific Tuning

### Single Character Scenes
**Recommended**: `<segment:yolo-face_yolo11m-seg.pt-1,0.35,0.5>`
- Standard parameters work well
- Single face detection is straightforward

### Multi-Character Scenes
**Recommended**: `<segment:yolo-face_yolo11m-seg.pt-1,0.35,0.5> <segment:yolo-face_yolo11m-seg.pt-2,0.35,0.5>`
- Same parameters for consistency
- Indexed tags ensure each character gets proper segmentation

### Crowd Scenes
**Consider**: `<segment:yolo-face_yolo11m-seg.pt,0.25,0.6>`
- Lower confidence (0.25) to catch more faces
- Higher IoU (0.6) to keep overlapping faces
- Remove `-INDEX` to detect all faces automatically

### Close-up Shots
**Consider**: `<segment:yolo-face_yolo11m-seg.pt-1,0.40,0.4>`
- Higher confidence (0.40) for clear face detection
- Lower IoU (0.4) for precise segmentation

### Wide Shots with Small Faces
**Consider**: `<segment:yolo-face_yolo11m-seg.pt,0.25,0.5>`
- Lower confidence (0.25) to catch small faces
- Standard IoU (0.5) for balanced suppression

## Troubleshooting Common Issues

### Problem: Faces Not Being Detected
**Symptoms**: No face segmentation masks generated
**Solutions**:
1. Lower confidence threshold: `0.25` instead of `0.35`
2. Check if faces are obscured or at extreme angles
3. Consider using `yolo11l-seg.pt` for better accuracy

### Problem: False Face Detections
**Symptoms**: Objects being detected as faces
**Solutions**:
1. Raise confidence threshold: `0.45` instead of `0.35`
2. Check prompt for ambiguous visual descriptions
3. Ensure face visibility is clearly described

### Problem: Duplicate Face Masks
**Symptoms**: Multiple masks for the same face
**Solutions**:
1. Lower IoU threshold: `0.3` instead of `0.5`
2. Use indexed tags (`-1`, `-2`) for specific characters
3. Ensure character positioning is clearly described

### Problem: Missing Faces in Crowds
**Symptoms**: Some faces not detected in multi-character scenes
**Solutions**:
1. Lower confidence: `0.25`
2. Raise IoU: `0.6` to keep overlapping detections
3. Remove indexed tags to detect all faces automatically

## Performance Considerations

### Processing Speed
- **yolo11n-seg.pt**: Fastest processing
- **yolo11m-seg.pt**: Balanced (our choice)
- **yolo11l-seg.pt**: Slower but more accurate

### Memory Usage
- Larger models require more VRAM
- Consider model size based on available hardware

### Batch Processing Impact
- YOLO processing happens during image generation
- Multiple characters = multiple YOLO passes
- Consider this in batch size calculations

## Implementation in StoryArt

### Current System Instructions
The AI is instructed to use:
```
<segment:yolo-face_yolo11m-seg.pt-INDEX,0.35,0.5>
```

### Dynamic Tuning (Future Enhancement)
Consider implementing scene-aware parameter selection:
- **Close-up scenes**: Higher confidence, lower IoU
- **Wide scenes**: Lower confidence, higher IoU
- **Crowd scenes**: Automatic detection without indexing

### Validation and Testing
1. **Test with various scene types**
2. **Monitor SwarmUI logs for warnings**
3. **Validate face detection accuracy**
4. **Adjust parameters based on results**

## Best Practices

### 1. Start Conservative
Begin with our current settings (0.35, 0.5) and adjust based on results.

### 2. Test Scene Types
Validate parameters across different scene types:
- Single character close-ups
- Multi-character conversations
- Wide establishing shots
- Crowd scenes

### 3. Monitor Logs
Watch for SwarmUI warnings about threshold resets.

### 4. Document Changes
Keep track of parameter adjustments and their effects.

### 5. A/B Testing
Compare results with different parameter sets to find optimal values.

## Future Enhancements

### 1. Scene-Aware Parameters
Implement dynamic parameter selection based on scene analysis.

### 2. Character-Specific Tuning
Adjust parameters based on character visibility and positioning.

### 3. Quality Metrics
Implement automatic quality assessment for face detection results.

### 4. Adaptive Learning
Use feedback from generated images to optimize parameters over time.

## Conclusion

The updated YOLO segmentation parameters (0.35 confidence, 0.5 IoU, yolo11m-seg.pt model) provide a solid foundation for face detection in StoryArt. These settings balance accuracy with performance while avoiding SwarmUI warnings.

Regular testing and parameter adjustment based on specific scene requirements will ensure optimal results across different content types.
